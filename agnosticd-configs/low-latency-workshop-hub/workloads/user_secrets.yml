---
# User Secrets Workload
# Creates labeled secrets for Dev Spaces auto-mount (kubeconfig and SSH keys)
# Called in a loop with user_num variable
# Idempotent - safe to re-run

- name: Set user facts
  ansible.builtin.set_fact:
    _user_name: "{{ workshop_user_base }}{{ user_num }}"
    _user_namespace: "{{ workshop_namespace_prefix }}{{ workshop_user_base }}{{ user_num }}"
    _sno_guid: "workshop-{{ workshop_user_base }}{{ user_num }}"

- name: Set SNO credential paths
  ansible.builtin.set_fact:
    _sno_kubeconfig_path: "{{ sno_output_dir }}/{{ _sno_guid }}/kubeconfig"
    _sno_kubeconfig_alt_path: "{{ sno_output_dir }}/{{ _sno_guid }}/low-latency-workshop-sno_{{ _sno_guid }}_kubeconfig"
    _sno_ssh_key_path: "{{ sno_output_dir }}/{{ _sno_guid }}/ssh_provision_{{ _sno_guid }}"

- name: Check if SNO kubeconfig exists (primary path)
  ansible.builtin.stat:
    path: "{{ _sno_kubeconfig_path }}"
  register: _kubeconfig_stat
  delegate_to: localhost

- name: Check if SNO kubeconfig exists (alternative path)
  ansible.builtin.stat:
    path: "{{ _sno_kubeconfig_alt_path }}"
  register: _kubeconfig_alt_stat
  delegate_to: localhost
  when: not _kubeconfig_stat.stat.exists

- name: Set actual kubeconfig path
  ansible.builtin.set_fact:
    _actual_kubeconfig_path: "{{ _sno_kubeconfig_path if _kubeconfig_stat.stat.exists else (_sno_kubeconfig_alt_path if (_kubeconfig_alt_stat.stat.exists | default(false)) else '') }}"

- name: Check if SSH key exists
  ansible.builtin.stat:
    path: "{{ _sno_ssh_key_path }}"
  register: _ssh_key_stat
  delegate_to: localhost

- name: Create kubeconfig secret for Dev Spaces auto-mount
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ _user_name }}-kubeconfig"
        namespace: "{{ _user_namespace }}"
        labels:
          workshop: low-latency
          student: "{{ _user_name }}"
          managed-by: agnosticd
          # Dev Spaces auto-mount labels
          controller.devfile.io/mount-to-devworkspace: "true"
          controller.devfile.io/watch-secret: "true"
        annotations:
          # Mount as file in .kube directory
          controller.devfile.io/mount-path: "{{ devspaces_kubeconfig_mount_path | default('/home/user/.kube') }}"
          controller.devfile.io/mount-as: subpath
      data:
        config: "{{ lookup('file', _actual_kubeconfig_path) | b64encode }}"
      type: Opaque
  when:
    - devspaces_mount_kubeconfig | default(true) | bool
    - _actual_kubeconfig_path | length > 0

- name: Create kubeconfig placeholder secret if SNO not deployed yet
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ _user_name }}-kubeconfig"
        namespace: "{{ _user_namespace }}"
        labels:
          workshop: low-latency
          student: "{{ _user_name }}"
          managed-by: agnosticd
          status: placeholder
          controller.devfile.io/mount-to-devworkspace: "true"
          controller.devfile.io/watch-secret: "true"
        annotations:
          controller.devfile.io/mount-path: "{{ devspaces_kubeconfig_mount_path | default('/home/user/.kube') }}"
          controller.devfile.io/mount-as: subpath
          description: "Placeholder - will be updated when SNO is deployed"
      stringData:
        config: |
          # Placeholder kubeconfig - SNO cluster not yet deployed
          # This will be updated automatically when the SNO cluster is ready
          apiVersion: v1
          kind: Config
          clusters: []
          contexts: []
          current-context: ""
          users: []
      type: Opaque
  when:
    - devspaces_mount_kubeconfig | default(true) | bool
    - _actual_kubeconfig_path | length == 0

- name: Create SSH key secret for Dev Spaces auto-mount
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ _user_name }}-ssh-key"
        namespace: "{{ _user_namespace }}"
        labels:
          workshop: low-latency
          student: "{{ _user_name }}"
          managed-by: agnosticd
          controller.devfile.io/mount-to-devworkspace: "true"
          controller.devfile.io/watch-secret: "true"
        annotations:
          controller.devfile.io/mount-path: "{{ devspaces_ssh_mount_path | default('/home/user/.ssh') }}"
          controller.devfile.io/mount-as: subpath
      data:
        id_rsa: "{{ lookup('file', _sno_ssh_key_path) | b64encode }}"
      type: Opaque
  when:
    - devspaces_mount_ssh_key | default(true) | bool
    - _ssh_key_stat.stat.exists

- name: Create SSH key placeholder secret if not available yet
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ _user_name }}-ssh-key"
        namespace: "{{ _user_namespace }}"
        labels:
          workshop: low-latency
          student: "{{ _user_name }}"
          managed-by: agnosticd
          status: placeholder
          controller.devfile.io/mount-to-devworkspace: "true"
          controller.devfile.io/watch-secret: "true"
        annotations:
          controller.devfile.io/mount-path: "{{ devspaces_ssh_mount_path | default('/home/user/.ssh') }}"
          controller.devfile.io/mount-as: subpath
          description: "Placeholder - will be updated when SNO is deployed"
      stringData:
        id_rsa: |
          # Placeholder SSH key - SNO cluster not yet deployed
          # This will be updated automatically when the SNO cluster is ready
      type: Opaque
  when:
    - devspaces_mount_ssh_key | default(true) | bool
    - not _ssh_key_stat.stat.exists

- name: Create SNO connection info ConfigMap (auto-mounted to Dev Spaces)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: "{{ _user_name }}-sno-info"
        namespace: "{{ _user_namespace }}"
        labels:
          workshop: low-latency
          student: "{{ _user_name }}"
          managed-by: agnosticd
          # Dev Spaces auto-mount labels (works for ConfigMaps too)
          controller.devfile.io/mount-to-devworkspace: "true"
          controller.devfile.io/watch-configmap: "true"
        annotations:
          controller.devfile.io/mount-path: /home/user/sno-info
          controller.devfile.io/mount-as: subpath
      data:
        SNO_GUID: "{{ _sno_guid }}"
        SNO_API_URL: "https://api.{{ _sno_guid }}.{{ subdomain_base_suffix | regex_replace('^\\.', '') }}:6443"
        SNO_CONSOLE_URL: "https://console-openshift-console.apps.{{ _sno_guid }}.{{ subdomain_base_suffix | regex_replace('^\\.', '') }}"
        BASTION_HOST: "bastion.{{ _sno_guid }}.{{ subdomain_base_suffix | regex_replace('^\\.', '') }}"
        USER_NAME: "{{ _user_name }}"
        KUBECONFIG_READY: "{{ 'true' if _actual_kubeconfig_path | length > 0 else 'false' }}"
        SSH_KEY_READY: "{{ 'true' if _ssh_key_stat.stat.exists else 'false' }}"

- name: Display secrets creation status
  ansible.builtin.debug:
    msg:
      - "âœ“ Secrets created for: {{ _user_name }}"
      - "Namespace: {{ _user_namespace }}"
      - "Kubeconfig: {{ 'Available' if _actual_kubeconfig_path | length > 0 else 'Placeholder (SNO not deployed)' }}"
      - "SSH Key: {{ 'Available' if _ssh_key_stat.stat.exists else 'Placeholder (SNO not deployed)' }}"

