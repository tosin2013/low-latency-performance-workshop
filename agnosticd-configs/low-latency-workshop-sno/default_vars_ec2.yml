---
# AWS EC2-specific configuration for low-latency-workshop-sno

# ============================================================
# Cloud Provider
# ============================================================
cloud_provider: ec2

# ============================================================
# AWS Region and Availability
# ============================================================
aws_region: us-east-2

# Use specific AZ if needed (optional)
# aws_availability_zone: us-east-2a

# ============================================================
# Instance Configuration for AgnosticD
# ============================================================
# Bastion instance - required to run openshift-install binary
instances:
  - name: bastion
    count: "{{ bastion_instance_count }}"
    unique: true
    # CRITICAL: Disable public DNS for bastion!
    # OpenShift installer validates that NO DNS records exist in parent zone
    # Having bastion.test-student1.sandbox862.opentlc.com blocks installation
    # Bastion can be accessed via public IP or private internal DNS
    public_dns: false
    dns_loadbalancer: false
    flavor:
      ec2: t3a.medium  # 2 vCPU, 4GB RAM - enough for openshift-install
    # SOLUTION: Added RHEL97GOLD to AgnosticD's AMI mapping table
    # ~/agnosticd/ansible/roles-infra/infra-ec2-template-generate/defaults/main.yml
    # CloudFormation uses Fn::FindInMap, so we need a symbolic name, not direct AMI
    image: RHEL90GOLD  # Resolves to ami-035032ea878eca201 (RHEL 9.7.0)
    tags:
      - key: AnsibleGroup
        value: bastions
      - key: ostype
        value: linux
      - key: instance_filter
        value: "{{ env_type }}-{{ email }}"
    security_groups:
      - BastionSG  # Alphanumeric name for CloudFormation

# ============================================================
# EC2 Instance Configuration
# ============================================================
# SNO requires sufficient resources for all-in-one deployment
sno_instance_type: m5.4xlarge  # 16 vCPU, 64GB RAM, 10 Gbps network

# Alternative instance types (if m5.4xlarge unavailable):
# - m5.8xlarge   (32 vCPU, 128GB RAM) - for larger workloads
# - m5n.4xlarge  (16 vCPU, 64GB RAM) - network-optimized
# - m5zn.3xlarge (12 vCPU, 48GB RAM) - high single-thread performance

# ============================================================
# EBS Volume Configuration
# ============================================================
sno_root_volume_size: 200  # GB
sno_root_volume_type: gp3  # General Purpose SSD v3

# gp3 performance characteristics
sno_root_volume_iops: 3000       # Default for gp3
sno_root_volume_throughput: 125  # MB/s

# ============================================================
# Networking
# ============================================================
# VPC Configuration
aws_vpc_cidr: "10.0.0.0/16"
aws_public_subnet_cidr: "10.0.1.0/24"

# Create new VPC for each SNO (isolation)
create_vpc: true

# Internet Gateway (required for SNO to download images)
create_internet_gateway: true

# ============================================================
# Security Groups
# ============================================================
# Default security group rules for SNO
# Note: CloudFormation resource names must be alphanumeric only
security_groups:
  - name: "SNOSG"
    description: "Security group for SNO cluster"
    rules:
      # OpenShift API
      - protocol: tcp
        port_range: 6443
        cidr: 0.0.0.0/0
        description: "OpenShift API"
      
      # OpenShift Console
      - protocol: tcp
        port_range: 443
        cidr: 0.0.0.0/0
        description: "OpenShift Console"
      
      # HTTP redirect
      - protocol: tcp
        port_range: 80
        cidr: 0.0.0.0/0
        description: "HTTP redirect"
      
      # SSH (for debugging)
      - protocol: tcp
        port_range: 22
        cidr: 0.0.0.0/0
        description: "SSH access"
      
      # Allow all outbound
      - protocol: -1
        port_range: -1
        cidr: 0.0.0.0/0
        description: "Allow all outbound"

# ============================================================
# DNS Configuration
# ============================================================
# Use Route53 for DNS (RHPDS standard)
use_route53: true

# Subdomain suffix (from secrets file)
subdomain_base_suffix: "{{ subdomain_base_suffix }}"

# CRITICAL: Do NOT create delegated public zone for SNO deployments
# The OpenShift installer will create DNS records directly in the parent zone
# Creating a delegated zone causes DNS resolution to fail from inside the VPC
# See: DNS_DELEGATION_CONFLICT.md for details
aws_dns_create_public_zone: false

# When not creating a delegated zone, provide the parent hosted zone ID
# This is used for:
#   1. Creating bastion DNS records
#   2. IAM permissions for Route53User
# NOTE: This is the RHPDS sandbox zone ID for sandbox862.opentlc.com
# Update this if deploying to a different RHPDS sandbox or custom domain
HostedZoneId: Z15NWZ2BBDRMLB

# ============================================================
# AWS Tags
# ============================================================
aws_tags:
  - key: "Project"
    value: "low-latency-workshop"
  - key: "Environment"
    value: "workshop"
  - key: "Student"
    value: "{{ student_name }}"
  - key: "ManagedBy"
    value: "AgnosticD"
  - key: "ClusterType"
    value: "SNO"
  - key: "Workshop"
    value: "low-latency-performance"

# ============================================================
# Cost Optimization
# ============================================================
# Spot instances not recommended for SNO (stability)
use_spot_instances: false

# Auto-shutdown (if supported by environment)
# auto_shutdown: false

# ============================================================
# AWS Service Limits
# ============================================================
# These are informational - adjust based on your account
# aws_ec2_instance_limit: 20
# aws_vpc_limit: 5
# aws_eip_limit: 5

# ============================================================
# Backup and Snapshots
# ============================================================
# Create EBS snapshots (optional)
create_ebs_snapshots: false

# Snapshot retention (days)
# snapshot_retention_days: 7

