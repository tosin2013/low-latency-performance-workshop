schemaVersion: 2.2.2
metadata:
  name: low-latency-workshop
  displayName: Low-Latency Performance Workshop
  description: |
    Development workspace for the Low-Latency Performance Workshop for OpenShift.
    Login to your SNO cluster using the credentials provided by your workshop admin.
  version: 1.0.0
  tags:
    - OpenShift
    - Kubernetes
    - Performance
    - Low-Latency
    - Workshop
  icon: https://www.redhat.com/favicon.ico
  language: Shell
  projectType: workshop

attributes:
  controller.devfile.io/storage-type: per-user
  .vscode/extensions.json: |
    {
      "recommendations": [
        "redhat.vscode-yaml",
        "ms-kubernetes-tools.vscode-kubernetes-tools"
      ]
    }

# Clone the workshop repository
projects:
  - name: workshop
    git:
      remotes:
        origin: https://github.com/tosin2013/low-latency-performance-workshop.git
      checkoutFrom:
        revision: feat/deployment-automation

# Components
components:
  # Main development tools container
  - name: tools
    container:
      image: quay.io/devspaces/udi-rhel8:latest
      memoryLimit: 4Gi
      memoryRequest: 1Gi
      cpuLimit: "2"
      cpuRequest: 500m
      mountSources: true
      sourceMapping: /projects
      env:
        - name: KUBECONFIG
          value: /home/user/.kube/config
        - name: WORKSHOP_HOME
          value: /projects/workshop
        - name: PATH
          value: /home/user/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        - name: TERM
          value: xterm-256color
      volumeMounts:
        - name: workshop-data
          path: /home/user/workshop-data

  # Workshop data volume
  - name: workshop-data
    volume:
      size: 2Gi

  # VS Code editor - init container to populate checode volume
  - name: che-code-injector
    container:
      image: quay.io/devspaces/code-rhel8:3.16
      command:
        - /entrypoint-init-container.sh
      memoryLimit: 256Mi
      memoryRequest: 32Mi
      cpuLimit: 500m
      cpuRequest: 30m
      volumeMounts:
        - name: checode
          path: /checode

  # VS Code editor - runtime
  - name: che-code-runtime
    container:
      image: quay.io/devspaces/code-rhel8:3.16
      command:
        - /checode/entrypoint-volume.sh
      memoryLimit: 2048Mi
      memoryRequest: 256Mi
      cpuLimit: 500m
      cpuRequest: 30m
      volumeMounts:
        - name: checode
          path: /checode
      env:
        - name: CHE_DASHBOARD_URL
          value: ""
        - name: OPENVSX_REGISTRY_URL
          value: ""
      endpoints:
        - name: che-code
          targetPort: 3100
          exposure: public
          secure: true
          protocol: https
          attributes:
            type: main
            discoverable: false
            urlRewriteSupported: true
            
  # VS Code volume
  - name: checode
    volume:
      size: 2Gi

# Commands
commands:
  # Init che-code (preStart)
  - id: init-che-code
    apply:
      component: che-code-injector

  # Welcome message with user info
  - id: show-workshop-info
    exec:
      label: "Workshop Info"
      component: tools
      workingDir: /projects/workshop
      commandLine: |
        echo ""
        echo "╔════════════════════════════════════════════════════════════════════╗"
        echo "║     LOW-LATENCY PERFORMANCE WORKSHOP                               ║"
        echo "╚════════════════════════════════════════════════════════════════════╝"
        echo ""
        USERNAME="${DEVWORKSPACE_NAMESPACE%-devspaces}"
        echo "  Username: ${USERNAME}"
        echo ""
        echo "  To login to your SNO cluster:"
        echo "    oc login https://api.workshop-${USERNAME}.<domain>:6443 -u ${USERNAME} -p <password>"
        echo ""
        echo "  See module-02 documentation for your specific cluster details."
        echo ""
      group:
        kind: run
        isDefault: true

  # Install workshop tools (kube-burner, yq)
  - id: install-workshop-tools
    exec:
      label: "Install Workshop Tools"
      component: tools
      workingDir: /home/user
      commandLine: |
        echo "╔════════════════════════════════════════════════════════════╗"
        echo "║  Installing Workshop Tools                                 ║"
        echo "╚════════════════════════════════════════════════════════════╝"
        echo ""
        mkdir -p ~/.local/bin
        
        # Install kube-burner v1.17.5
        echo "[1/2] kube-burner..."
        if command -v kube-burner &> /dev/null; then
          echo "  ✓ kube-burner already installed"
        else
          curl -sL https://github.com/kube-burner/kube-burner/releases/download/v1.17.5/kube-burner-V1.17.5-linux-x86_64.tar.gz | tar -xzf - -C ~/.local/bin kube-burner
          chmod +x ~/.local/bin/kube-burner
          echo "  ✓ kube-burner installed"
        fi
        
        # Install yq v4.40.5
        echo "[2/2] yq..."
        if command -v yq &> /dev/null; then
          echo "  ✓ yq already installed"
        else
          curl -sL https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64 -o ~/.local/bin/yq
          chmod +x ~/.local/bin/yq
          echo "  ✓ yq installed"
        fi
        
        echo ""
        echo "╔════════════════════════════════════════════════════════════╗"
        echo "║  Tools Ready                                               ║"
        echo "╚════════════════════════════════════════════════════════════╝"
        echo ""
        echo "  oc:          $(oc version --client 2>/dev/null | head -1)"
        echo "  kubectl:     $(kubectl version --client 2>/dev/null | head -1)"
        echo "  kube-burner: $(kube-burner version 2>/dev/null | head -1)"
        echo "  jq:          $(jq --version 2>/dev/null)"
        echo "  yq:          $(yq --version 2>/dev/null)"
        echo "  git:         $(git --version 2>/dev/null)"
          echo ""
      group:
        kind: build

# Events - initialize editor before starting workspace
events:
  preStart:
    - init-che-code
  postStart:
    - install-workshop-tools
